// This is your Prisma schema file for Workshop Service
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [postgis]
}

// ============================================
// WORKSHOP SERVICE MODELS
// ============================================

model Workshop {
  id          String   @id @default(uuid())
  ownerId     String   // Foreign key to Auth Service (WORKSHOP_ADMIN)
  
  // Basic info
  name        String
  description String?
  phone       String
  email       String?
  website     String?
  
  // Address
  street      String
  city        String
  state       String
  zipCode     String
  country     String   @default("Mexico")
  
  // Geolocation (PostGIS)
  latitude    Float
  longitude   Float
  // location    Unsupported("geography(Point, 4326)")? // PostGIS geography type
  
  // Business hours
  openingTime String?  // "08:00"
  closingTime String?  // "18:00"
  workingDays String[] // ["Monday", "Tuesday", ...]
  
  // Specialties
  specialties String[] // ["Transmisión", "Frenos", "Motor", etc.]
  brands      String[] // ["Toyota", "Honda", "Nissan", etc.]
  
  // Pricing (indicativo)
  priceRange  PriceRange @default(MEDIUM)
  
  // Ratings
  averageRating Float   @default(0)
  totalReviews  Int     @default(0)
  
  // Capacity
  dailyCapacity Int     @default(10) // Número de citas por día
  
  // Status
  isActive      Boolean @default(true)
  isVerified    Boolean @default(false)
  
  // Media
  logo          String?
  photos        String[] // Array of photo URLs
  
  // Relationships
  availability  WorkshopAvailability[]
  reviews       Review[]
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([ownerId])
  @@index([city, state])
  // @@index([location], type: Gist) // PostGIS spatial index
  @@map("workshops")
}

enum PriceRange {
  LOW
  MEDIUM
  HIGH
  PREMIUM
}

// ============================================
// WORKSHOP AVAILABILITY
// ============================================

model WorkshopAvailability {
  id          String   @id @default(uuid())
  workshopId  String
  workshop    Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  
  // Date
  date        DateTime @db.Date
  
  // Time slots
  startTime   String   // "08:00"
  endTime     String   // "09:00"
  
  // Capacity
  maxAppointments Int  @default(1)
  bookedCount     Int  @default(0)
  
  // Status
  isAvailable Boolean  @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([workshopId, date, startTime])
  @@index([workshopId, date])
  @@map("workshop_availability")
}

// ============================================
// REVIEWS
// ============================================

model Review {
  id          String   @id @default(uuid())
  workshopId  String
  workshop    Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  
  userId      String   // Foreign key to Auth Service
  appointmentId String? // Foreign key to Appointment Service
  
  // Rating (1-5 stars)
  overallRating   Int // 1-5
  qualityRating   Int // 1-5
  priceRating     Int // 1-5
  timelinessRating Int // 1-5
  serviceRating   Int // 1-5
  
  // Review content
  comment     String?
  
  // Response from workshop
  response    String?
  respondedAt DateTime?
  
  // Verification
  isVerified  Boolean  @default(false)
  
  // Status
  isReported  Boolean  @default(false)
  reportReason String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([workshopId])
  @@index([userId])
  @@index([appointmentId])
  @@map("reviews")
}

// ============================================
// SERVICE CATEGORIES
// ============================================

model ServiceCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  icon        String?
  
  // Average pricing
  averagePrice Float?
  priceUnit    String?  // "por hora", "por servicio", etc.
  
  // Popular services
  services    Service[]
  
  // Status
  isActive    Boolean  @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("service_categories")
}

model Service {
  id          String   @id @default(uuid())
  categoryId  String
  category    ServiceCategory @relation(fields: [categoryId], references: [id])
  
  name        String
  description String?
  
  // Pricing
  estimatedPrice Float?
  duration       Int?    // Duración estimada en minutos
  
  // Status
  isActive    Boolean  @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([categoryId])
  @@map("services")
}
